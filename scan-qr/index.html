<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <rect width='100' height='100' fill='%232c3e50'/>
            <text x='50%' y='50%' font-size='60' 
            text-anchor='middle' dominant-baseline='middle' 
            fill='%23ffffff' font-family='sans-serif'>
            S
            </text>
        </svg>">
    <link rel="shortcut icon"
        href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <rect width='100' height='100' fill='%232c3e50'/>
            <text x='50%' y='50%' font-size='60' 
            text-anchor='middle' dominant-baseline='middle' 
            fill='%23ffffff' font-family='sans-serif'>
            S
            </text>
        </svg>">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>扫码功能</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <style>
      /* 全局布局 */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f0f0f0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 20px;
      }
  
      /* 结果显示区域 */
      #result {
        width: 100%;
        max-width: 500px;
        height: 60%;
        overflow-wrap: break-word;
        word-wrap: break-word; /* 确保文本换行 */
        word-break: break-word; /* 确保超长文本会换行 */
        font-size: 20px;
        color: #333;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        line-height: 1.4;
      }
  
      /* 按钮样式 */
      #startButton {
        padding: 20px 40px;
        font-size: 18px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }
  
      #startButton:hover {
        background-color: #45a049;
      }
  
      /* canvas 样式 */
      #canvas {
        display: none;
      }
  
      /* 页面布局容器 */
      .container {
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
      }
  
      .top-section {
        flex: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }
  
      .bottom-section {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-section">
        <div id="result">扫描结果将在这里显示</div>
      </div>
      <div class="bottom-section">
        <button id="startButton">启动摄像头</button>
      </div>
    </div>
  
    <canvas id="canvas"></canvas>
  
    <script>
      const canvas = document.getElementById('canvas');
      const canvasContext = canvas.getContext('2d');
      const resultDiv = document.getElementById('result');
      const startButton = document.getElementById('startButton');
      let stream;
  
      // 获取摄像头权限并启动视频流
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }  // 使用后置摄像头
          });
          const video = document.createElement('video');
          video.srcObject = stream;
          video.play();
          video.style.position = 'absolute'; // 隐藏视频流
          video.style.top = 0;
          video.style.left = 0;
  
          // 添加 video 到页面并启动扫码
          document.body.appendChild(video);
          startScanning(video); // 启动扫码过程
        } catch (error) {
          console.error('获取摄像头失败:', error);
        }
      }
  
      // 扫描视频流中的二维码或一维码并显示实时预览
      function scanQRCode(video) {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.height = video.videoHeight;
          canvas.width = video.videoWidth;
          canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height); // 绘制视频帧到 canvas
  
          const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
          const qrCode = jsQR(imageData.data, canvas.width, canvas.height);
  
          if (qrCode) {
            // 扫描成功，显示结果并停止摄像头
            resultDiv.innerText = `扫码结果: ${qrCode.data}`;
  
            // 强制 "挤退" 窗口，触发摄像头停止
            alert("扫码成功！");
            stopCamera(video); // 停止摄像头
            return; // 一旦扫描成功，停止后续扫描
          }
        }
  
        requestAnimationFrame(() => scanQRCode(video)); // 继续下一帧的扫描
      }
  
      // 停止摄像头并释放资源
      function stopCamera(video) {
        if (stream) {
          const tracks = stream.getTracks();
          tracks.forEach(track => track.stop()); // 停止所有摄像头的轨道
          video.srcObject = null;  // 断开视频流
          video.remove(); // 移除 video 元素
        }
      }
  
      // 启动扫码过程
      function startScanning(video) {
        scanQRCode(video);
      }
  
      // 绑定按钮点击事件，触发摄像头启动
      startButton.addEventListener('click', startCamera);
    </script>
  </body>
  </html>