<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="icon" href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <rect width='100' height='100' fill='%232c3e50'/>
            <text x='50%' y='50%' font-size='60' 
            text-anchor='middle' dominant-baseline='middle' 
            fill='%23ffffff' font-family='sans-serif'>
            S
            </text>
        </svg>">
    <link rel="shortcut icon"
        href="data:image/svg+xml,
        <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
            <rect width='100' height='100' fill='%232c3e50'/>
            <text x='50%' y='50%' font-size='60' 
            text-anchor='middle' dominant-baseline='middle' 
            fill='%23ffffff' font-family='sans-serif'>
            S
            </text>
        </svg>">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>扫码功能</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
    <style>
      #videoElement {
        width: 100%;
        height: auto;
        border: 1px solid black;
      }
      #canvas {
        display: none;
      }
      #result {
        margin-top: 10px;
        font-size: 18px;
        color: green;
      }
    </style>
  </head>
  <body>
    <h2>扫码功能</h2>
    <button id="startButton">启动摄像头</button>
    <video id="videoElement" autoplay></video>
    <canvas id="canvas"></canvas>
    <div id="result"></div>
  
    <script>
      const videoElement = document.getElementById('videoElement');
      const canvas = document.getElementById('canvas');
      const canvasContext = canvas.getContext('2d');
      const resultDiv = document.getElementById('result');
      const startButton = document.getElementById('startButton');
      let stream;
  
      // 获取摄像头权限并启动视频流
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }  // 使用后置摄像头
          });
          videoElement.srcObject = stream;
          startScanning();  // 启动扫码过程
        } catch (error) {
          console.error('获取摄像头失败:', error);
        }
      }
  
      // 停止摄像头并挤退系统窗口
      function stopCamera() {
        if (stream) {
          const tracks = stream.getTracks();
          tracks.forEach(track => track.stop()); // 停止所有摄像头的轨道
          videoElement.srcObject = null;  // 断开视频流
        }
      }
  
      // 扫描视频流中的二维码或一维码并显示实时预览
      function scanQRCode() {
        if (videoElement.readyState === videoElement.HAVE_ENOUGH_DATA) {
          canvas.height = videoElement.videoHeight;
          canvas.width = videoElement.videoWidth;
          canvasContext.drawImage(videoElement, 0, 0, canvas.width, canvas.height); // 绘制视频帧到 canvas
  
          const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
          const qrCode = jsQR(imageData.data, canvas.width, canvas.height);
  
          if (qrCode) {
            // 扫描成功，显示结果并停止摄像头
            resultDiv.innerText = `扫码结果: ${qrCode.data}`;
            
            // 强制 "挤退" 窗口，触发摄像头停止
            alert("扫码成功！");
            stopCamera(); // 停止摄像头
            videoElement.style.display = 'none'; // 隐藏视频元素，避免黑屏
  
            // 清除预览内容，确保可以重新启动摄像头
            setTimeout(() => {
              videoElement.style.display = 'block';  // 显示视频元素
              videoElement.srcObject = null;         // 清除视频源
              startCamera();                         // 重新启动摄像头
            }, 1000); // 延时 1 秒后重启摄像头，避免 UI 更新滞后
            return; // 一旦扫描成功，停止后续扫描
          }
        }
  
        requestAnimationFrame(scanQRCode); // 继续下一帧的扫描
      }
  
      // 启动扫码过程
      function startScanning() {
        scanQRCode();
      }
  
      // 绑定按钮点击事件，触发摄像头启动
      startButton.addEventListener('click', startCamera);
    </script>
  </body>
  </html>